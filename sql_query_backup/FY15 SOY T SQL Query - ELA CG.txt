-- These queries set up data for start-of-year student performance data reporting.

-- QUERY SYNTAX (Merge in columns from RPT_STUDENT_MAIN and RPT_SCHOOL_GRADE -- STEP 1):

SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_ELA_CG_VALUE, prepost.PRE_ELA_CG_VALUE_DISPLAY, prepost.PRE_ELA_CG_VALUE_NUM, prepost.PRE_ELA_DESC, prepost.PRE_ELA_FREQ, prepost.PRE_ELA_TRACK, prepost.PRE_ELA_TRACK_EVAL, prepost.PRE_SCENARIO, prepost.PRE_LETTER_VIEW, prepost.PRE_CG_LETTER_SCALE_ALL, prepost.DOSAGE_CATEGORY, prepost.TTL_TIME, prepost.POST_ELA_CG_VALUE, prepost.POST_ELA_CG_VALUE_DISPLAY, prepost.POST_ELA_CG_VALUE_NUM, prepost.POST_ELA_DESC, prepost.POST_ELA_FREQ, prepost.POST_ELA_TRACK, prepost.POST_ELA_TRACK_EVAL, prepost.POST_SCENARIO, prepost.POST_LETTER_VIEW, prepost.POST_CG_LETTER_SCALE_ALL, prepost.LETTERGADE_CHANGE_ACTUAL, prepost.LETTERGADE_CHANGE_GENERAL, prepost.CG_Performance_Level_Change, prepost.CG_Change, prepost.Enrollment_Duration, prepost.ENROLL_DAYS, prepost.STATUS_SITE_DOSAGE_GOAL, prepost.SITE_DOSAGE_GOAL, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, prepost.FISCAL_YEAR, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN ReportCYData.dbo.EVAL_ELA AS prepost
	ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 3)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015';

-- QUERY SYNTAX (Merge to pre/post ELA CG data -- BASED ON ABOVE QUERY -- STEP 2 -- this extra step is required since calculations/joins on new variables can't reference variables that were just created in the same query):

DROP TABLE ImpactAnalytics.dbo.FY15_SOY_ELA_CG
SELECT ELACG.*
INTO ImpactAnalytics.dbo.FY15_SOY_ELA_CG
FROM
(*****ABOVE_QUERY*****)
AS ELACG
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;

-- QUERY SYNTAX (Merge letter grade change variable to pre/post ELA CG data -- SINGLE QUERY VERSION):

DROP TABLE ImpactAnalytics.dbo.FY15_SOY_ELA_CG
SELECT ELACG.*
INTO ImpactAnalytics.dbo.FY15_SOY_ELA_CG
FROM
(SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_ELA_CG_VALUE, prepost.PRE_ELA_CG_VALUE_DISPLAY, prepost.PRE_ELA_CG_VALUE_NUM, prepost.PRE_ELA_DESC, prepost.PRE_ELA_FREQ, prepost.PRE_ELA_TRACK, prepost.PRE_ELA_TRACK_EVAL, prepost.PRE_SCENARIO, prepost.PRE_LETTER_VIEW, prepost.PRE_CG_LETTER_SCALE_ALL, prepost.DOSAGE_CATEGORY, prepost.TTL_TIME, prepost.POST_ELA_CG_VALUE, prepost.POST_ELA_CG_VALUE_DISPLAY, prepost.POST_ELA_CG_VALUE_NUM, prepost.POST_ELA_DESC, prepost.POST_ELA_FREQ, prepost.POST_ELA_TRACK, prepost.POST_ELA_TRACK_EVAL, prepost.POST_SCENARIO, prepost.POST_LETTER_VIEW, prepost.POST_CG_LETTER_SCALE_ALL, prepost.LETTERGADE_CHANGE_ACTUAL, prepost.LETTERGADE_CHANGE_GENERAL, prepost.CG_Performance_Level_Change, prepost.CG_Change, prepost.Enrollment_Duration, prepost.ENROLL_DAYS, prepost.STATUS_SITE_DOSAGE_GOAL, prepost.SITE_DOSAGE_GOAL, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, prepost.FISCAL_YEAR, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN ReportCYData.dbo.EVAL_ELA AS prepost
	ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 3)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015')
AS ELACG
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;