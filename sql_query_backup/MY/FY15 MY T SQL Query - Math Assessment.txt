-- This query sets up data for FY15 mid-year student performance data reporting: Math Assessments.
-- Step 1 nests within step 2, which nests within step 3. Replace "*****ABOVE_QUERY*****" with the query text in the preceding step.
-- The final section (QUERY SYNTAX (SINGLE QUERY VERSION)) is the final query that should be set up in a stored procedure in the reporting DB. This step is just a copy of all previous steps, properly nested.


-- QUERY SYNTAX (Select latest math assessment, excluding pre/post tagged data points, from RPT_PERFORMANCE_LEVEL -- STEP 1):

SELECT allMTH1.CONFIG_ID, allMTH1.STUDENT_ID, allMTH1.FREQUENCY_PERIOD_ID, allMTH1.SKILL_ID, allMTH1.SKILL_DESCRIPTION, allMTH1.INTERVAL, allMTH1.INDICATOR_DESC, allMTH1.FREQ_SORT, allMTH1.SCHOOL_NAME, allMTH1.SITE_NAME, allMTH1.STUDENT_NAME, allMTH1.SCHOOL_ID, allMTH1.SITE_ID, allMTH1.PERF_DATE, allMTH1.PERFORMANCE_VALUE, allMTH1.PERFORMANCE_VALUE_NUMERIC, allMTH1.SCALE_LOCAL, allMTH1.SCALE_EVAL, allMTH1.SCALE_TYPE, allMTH1.PERF_DIRECTION, allMTH1.PROC_TYPE, allMTH1.PERF_RUN_DATE, allMTH1.INDICATOR_AREA_ID, allMTH1.CONFIG_NAME, allMTH1.PRIMARY_CM, allMTH1.INTERVENTION_TIME, allMTH1.DATA_POINT, allMTH1.CG_VALUE_DISPLAY, allMTH1.CG_VALUE_NUM, allMTH1.CG_LETTER_VIEW, allMTH1.CG_LETTER_VIEW_ALL, allMTH1.Tag, allMTH1.FISCAL_YEAR
FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL AS allMTH1 LEFT JOIN ReportCYData.dbo.RPT_PERFORMANCE_LEVEL AS allMTH2
ON allMTH1.STUDENT_ID = allMTH2.STUDENT_ID AND allMTH1.INDICATOR_DESC = allMTH2.INDICATOR_DESC AND allMTH1.PERF_DATE < allMTH2.PERF_DATE
WHERE allMTH1.CONFIG_NAME LIKE 'Math Assessment%' AND allMTH1.Tag IS NULL AND allMTH1.FISCAL_YEAR LIKE '2014-2015' AND allMTH2.STUDENT_ID IS NULL;


-- QUERY SYNTAX (Merge in numeric variable of local assessment performance level for MY/proxy -- STEP 2):

SELECT proxyMTH.CONFIG_ID, proxyMTH.STUDENT_ID, proxyMTH.FREQUENCY_PERIOD_ID, proxyMTH.SKILL_ID, proxyMTH.SKILL_DESCRIPTION, proxyMTH.INTERVAL, proxyMTH.INDICATOR_DESC, proxyMTH.FREQ_SORT, proxyMTH.SCHOOL_NAME, proxyMTH.SITE_NAME, proxyMTH.STUDENT_NAME, proxyMTH.SCHOOL_ID, proxyMTH.SITE_ID, proxyMTH.PERF_DATE, proxyMTH.PERFORMANCE_VALUE, proxyMTH.PERFORMANCE_VALUE_NUMERIC, ReportCYData.dbo.RPT_ASSESSMENT_NUM.SCALE_NUM, proxyMTH.SCALE_LOCAL, proxyMTH.SCALE_EVAL, proxyMTH.SCALE_TYPE, proxyMTH.PERF_DIRECTION, proxyMTH.PROC_TYPE, proxyMTH.PERF_RUN_DATE, proxyMTH.INDICATOR_AREA_ID, proxyMTH.CONFIG_NAME, proxyMTH.PRIMARY_CM, proxyMTH.INTERVENTION_TIME, proxyMTH.DATA_POINT, proxyMTH.CG_VALUE_DISPLAY, proxyMTH.CG_VALUE_NUM, proxyMTH.CG_LETTER_VIEW, proxyMTH.CG_LETTER_VIEW_ALL, proxyMTH.Tag, proxyMTH.FISCAL_YEAR
FROM
(*****ABOVE_QUERY*****)
AS proxyMTH LEFT JOIN ReportCYData.dbo.RPT_ASSESSMENT_NUM
ON ReportCYData.dbo.RPT_ASSESSMENT_NUM.SITE_ID = proxyMTH.SITE_ID AND ReportCYData.dbo.RPT_ASSESSMENT_NUM.ASSESSMENT_NAME LIKE proxyMTH.SKILL_DESCRIPTION AND ReportCYData.dbo.RPT_ASSESSMENT_NUM.SCALE LIKE proxyMTH.SCALE_LOCAL AND ReportCYData.dbo.RPT_ASSESSMENT_NUM.INDICATOR_AREA LIKE proxyMTH.INDICATOR_DESC;


-- QUERY SYNTAX (Merge in columns from RPT_STUDENT_MAIN, RPT_SCHOOL_GRADE, and the selected data points from the query above, to EVAL_ASSESSMENT (pre/post data). Select post/proxy-post data points, where the post data point is selected if available, otherwise use the latest performance data available. -- BASED ON ABOVE QUERY -- STEP 3):

SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.ASSESSMENT_TYPE, prepost.PRE_VALUE, prepost.PRE_VALUE_DISPLAY, prepost.PRE_VALUE_NUM, prepost.PRE_DATE, prepost.PRE_DESC, prepost.PRE_TRACK_NUM, prepost.PRE_TRACK, prepost.PRE_TRACK_EVAL, prepost.PRE_TRACK_NATIONAL, prepost.POST_VALUE, prepost.POST_VALUE_DISPLAY, prepost.POST_VALUE_NUM, prepost.POST_DATE, prepost.POST_DESC, prepost.POST_TRACK_NUM, prepost.POST_TRACK, prepost.POST_TRACK_EVAL, prepost.POST_TRACK_NATIONAL, prepost.DOSAGE_CATEGORY, prepost.TTL_TIME, prepost.ENROLLED_DAYS_CATEGORIES, prepost.CURRENTLY_ENROLLED, prepost.ENROLLED_DAYS, prepost.LIT_ASSESS_RAWCHANGE, prepost.LIT_ASSESS_RAWCHANGE_DEGREE, prepost.LIT_ASSESS_PERFORMANCECHANGE_LOCAL, prepost.LIT_ASSESS_PERFORMANCECHANGE_NORMALIZED, prepost.LIT_ASSESS_PERCENTCHANGE, prepost.STATUS_SITE_DOSAGE_GOAL, prepost.SITE_DOSAGE_GOAL, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, prepost.FISCAL_YEAR, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.TTL_TIME >= ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 1 WHEN prepost.TTL_TIME < ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 0 ELSE NULL END AS MY_MET_MARCH_DOSAGE,
MY_PROXY_MTHAssess.PERF_DATE AS PROXY_DATE, MY_PROXY_MTHAssess.SKILL_DESCRIPTION AS PROXY_DESC, MY_PROXY_MTHAssess.PERFORMANCE_VALUE_NUMERIC AS PROXY_VALUE_NUM, MY_PROXY_MTHAssess.SCALE_LOCAL AS PROXY_TRACK, MY_PROXY_MTHAssess.SCALE_EVAL AS PROXY_TRACK_EVAL,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.PERF_DATE ELSE prepost.POST_DATE END AS MY_PERF_DATE,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.SKILL_DESCRIPTION ELSE prepost.POST_DESC END AS MY_DESC,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.PERFORMANCE_VALUE_NUMERIC ELSE prepost.POST_VALUE_NUM END AS MY_VALUE_NUM,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN NULL ELSE prepost.POST_TRACK_NUM END AS MY_TRACK_NUM,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.SCALE_LOCAL ELSE prepost.POST_TRACK END AS MY_TRACK,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.SCALE_EVAL ELSE prepost.POST_TRACK_EVAL END AS MY_TRACK_EVAL
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN (ReportCYData.dbo.EVAL_ASSESSMENT AS prepost LEFT JOIN 
(*****ABOVE_QUERY*****)
AS MY_PROXY_MTHAssess ON (prepost.STUDENT_ID = MY_PROXY_MTHAssess.STUDENT_ID)) ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 5 AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015' AND prepost.ASSESSMENT_TYPE LIKE 'MATH_ASSESS' AND prepost.FISCAL_YEAR LIKE '2014-2015';


-- QUERY SYNTAX (Re-populate old table, calculate additional post/proxy-post variables -- BASED ON ABOVE QUERY -- STEP 4 -- this extra step is required since calculations for new variables can't reference variables that were just created in the same query):

DROP TABLE ImpactAnalytics.dbo.FY15_MY_MTH_ASSESS_subtable
SELECT MTH.*,
CASE WHEN MTH.PRE_VALUE_NUM < MTH.MY_VALUE_NUM THEN 'Increase' WHEN MTH.PRE_VALUE_NUM = MTH.MY_VALUE_NUM THEN 'No Change' WHEN MTH.PRE_VALUE_NUM > MTH.MY_VALUE_NUM THEN 'Decrease' ELSE 'Insufficient Data' END AS MY_RAWCHANGE_DEGREE,
CASE WHEN MTH.PRE_TRACK IS NOT NULL AND MTH.MY_TRACK IS NOT NULL THEN MTH.PRE_TRACK + ' to ' + MTH.MY_TRACK ELSE 'Insufficient Data' END AS MY_PERFORMANCECHANGE_LOCAL,
CASE WHEN MTH.PRE_TRACK_EVAL IS NOT NULL AND MTH.MY_TRACK_EVAL IS NOT NULL THEN MTH.PRE_TRACK_EVAL + ' to ' + MTH.MY_TRACK_EVAL ELSE 'Insufficient Data' END AS MY_PERFORMANCECHANGE_NORMALIZED
INTO ImpactAnalytics.dbo.FY15_MY_MTH_ASSESS_subtable
FROM
(*****ABOVE_QUERY*****)
AS MTH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;


-- QUERY SYNTAX (SINGLE QUERY VERSION):

DROP TABLE ImpactAnalytics.dbo.FY15_MY_MTH_ASSESS_subtable
SELECT MTH.*,
CASE WHEN MTH.PRE_VALUE_NUM < MTH.MY_VALUE_NUM THEN 'Increase' WHEN MTH.PRE_VALUE_NUM = MTH.MY_VALUE_NUM THEN 'No Change' WHEN MTH.PRE_VALUE_NUM > MTH.MY_VALUE_NUM THEN 'Decrease' ELSE 'Insufficient Data' END AS MY_RAWCHANGE_DEGREE,
CASE WHEN MTH.PRE_TRACK IS NOT NULL AND MTH.MY_TRACK IS NOT NULL THEN MTH.PRE_TRACK + ' to ' + MTH.MY_TRACK ELSE 'Insufficient Data' END AS MY_PERFORMANCECHANGE_LOCAL,
CASE WHEN MTH.PRE_TRACK_EVAL IS NOT NULL AND MTH.MY_TRACK_EVAL IS NOT NULL THEN MTH.PRE_TRACK_EVAL + ' to ' + MTH.MY_TRACK_EVAL ELSE 'Insufficient Data' END AS MY_PERFORMANCECHANGE_NORMALIZED
INTO ImpactAnalytics.dbo.FY15_MY_MTH_ASSESS_subtable
FROM
(SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.ASSESSMENT_TYPE, prepost.PRE_VALUE, prepost.PRE_VALUE_DISPLAY, prepost.PRE_VALUE_NUM, prepost.PRE_DATE, prepost.PRE_DESC, prepost.PRE_TRACK_NUM, prepost.PRE_TRACK, prepost.PRE_TRACK_EVAL, prepost.PRE_TRACK_NATIONAL, prepost.POST_VALUE, prepost.POST_VALUE_DISPLAY, prepost.POST_VALUE_NUM, prepost.POST_DATE, prepost.POST_DESC, prepost.POST_TRACK_NUM, prepost.POST_TRACK, prepost.POST_TRACK_EVAL, prepost.POST_TRACK_NATIONAL, prepost.DOSAGE_CATEGORY, prepost.TTL_TIME, prepost.ENROLLED_DAYS_CATEGORIES, prepost.CURRENTLY_ENROLLED, prepost.ENROLLED_DAYS, prepost.LIT_ASSESS_RAWCHANGE, prepost.LIT_ASSESS_RAWCHANGE_DEGREE, prepost.LIT_ASSESS_PERFORMANCECHANGE_LOCAL, prepost.LIT_ASSESS_PERFORMANCECHANGE_NORMALIZED, prepost.LIT_ASSESS_PERCENTCHANGE, prepost.STATUS_SITE_DOSAGE_GOAL, prepost.SITE_DOSAGE_GOAL, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, prepost.FISCAL_YEAR, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.TTL_TIME >= ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 1 WHEN prepost.TTL_TIME < ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 0 ELSE NULL END AS MY_MET_MARCH_DOSAGE,
MY_PROXY_MTHAssess.PERF_DATE AS PROXY_DATE, MY_PROXY_MTHAssess.SKILL_DESCRIPTION AS PROXY_DESC, MY_PROXY_MTHAssess.PERFORMANCE_VALUE_NUMERIC AS PROXY_VALUE_NUM, MY_PROXY_MTHAssess.SCALE_LOCAL AS PROXY_TRACK, MY_PROXY_MTHAssess.SCALE_EVAL AS PROXY_TRACK_EVAL,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.PERF_DATE ELSE prepost.POST_DATE END AS MY_PERF_DATE,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.SKILL_DESCRIPTION ELSE prepost.POST_DESC END AS MY_DESC,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.PERFORMANCE_VALUE_NUMERIC ELSE prepost.POST_VALUE_NUM END AS MY_VALUE_NUM,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN NULL ELSE prepost.POST_TRACK_NUM END AS MY_TRACK_NUM,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.SCALE_LOCAL ELSE prepost.POST_TRACK END AS MY_TRACK,
CASE WHEN prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION THEN MY_PROXY_MTHAssess.SCALE_EVAL ELSE prepost.POST_TRACK_EVAL END AS MY_TRACK_EVAL
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN (ReportCYData.dbo.EVAL_ASSESSMENT AS prepost LEFT JOIN 
(SELECT proxyMTH.CONFIG_ID, proxyMTH.STUDENT_ID, proxyMTH.FREQUENCY_PERIOD_ID, proxyMTH.SKILL_ID, proxyMTH.SKILL_DESCRIPTION, proxyMTH.INTERVAL, proxyMTH.INDICATOR_DESC, proxyMTH.FREQ_SORT, proxyMTH.SCHOOL_NAME, proxyMTH.SITE_NAME, proxyMTH.STUDENT_NAME, proxyMTH.SCHOOL_ID, proxyMTH.SITE_ID, proxyMTH.PERF_DATE, proxyMTH.PERFORMANCE_VALUE, proxyMTH.PERFORMANCE_VALUE_NUMERIC, ReportCYData.dbo.RPT_ASSESSMENT_NUM.SCALE_NUM, proxyMTH.SCALE_LOCAL, proxyMTH.SCALE_EVAL, proxyMTH.SCALE_TYPE, proxyMTH.PERF_DIRECTION, proxyMTH.PROC_TYPE, proxyMTH.PERF_RUN_DATE, proxyMTH.INDICATOR_AREA_ID, proxyMTH.CONFIG_NAME, proxyMTH.PRIMARY_CM, proxyMTH.INTERVENTION_TIME, proxyMTH.DATA_POINT, proxyMTH.CG_VALUE_DISPLAY, proxyMTH.CG_VALUE_NUM, proxyMTH.CG_LETTER_VIEW, proxyMTH.CG_LETTER_VIEW_ALL, proxyMTH.Tag, proxyMTH.FISCAL_YEAR
FROM
(SELECT allMTH1.CONFIG_ID, allMTH1.STUDENT_ID, allMTH1.FREQUENCY_PERIOD_ID, allMTH1.SKILL_ID, allMTH1.SKILL_DESCRIPTION, allMTH1.INTERVAL, allMTH1.INDICATOR_DESC, allMTH1.FREQ_SORT, allMTH1.SCHOOL_NAME, allMTH1.SITE_NAME, allMTH1.STUDENT_NAME, allMTH1.SCHOOL_ID, allMTH1.SITE_ID, allMTH1.PERF_DATE, allMTH1.PERFORMANCE_VALUE, allMTH1.PERFORMANCE_VALUE_NUMERIC, allMTH1.SCALE_LOCAL, allMTH1.SCALE_EVAL, allMTH1.SCALE_TYPE, allMTH1.PERF_DIRECTION, allMTH1.PROC_TYPE, allMTH1.PERF_RUN_DATE, allMTH1.INDICATOR_AREA_ID, allMTH1.CONFIG_NAME, allMTH1.PRIMARY_CM, allMTH1.INTERVENTION_TIME, allMTH1.DATA_POINT, allMTH1.CG_VALUE_DISPLAY, allMTH1.CG_VALUE_NUM, allMTH1.CG_LETTER_VIEW, allMTH1.CG_LETTER_VIEW_ALL, allMTH1.Tag, allMTH1.FISCAL_YEAR
FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL AS allMTH1 LEFT JOIN ReportCYData.dbo.RPT_PERFORMANCE_LEVEL AS allMTH2
ON allMTH1.STUDENT_ID = allMTH2.STUDENT_ID AND allMTH1.INDICATOR_DESC = allMTH2.INDICATOR_DESC AND allMTH1.PERF_DATE < allMTH2.PERF_DATE
WHERE allMTH1.CONFIG_NAME LIKE 'Math Assessment%' AND allMTH1.Tag IS NULL AND allMTH1.FISCAL_YEAR LIKE '2014-2015' AND allMTH2.STUDENT_ID IS NULL)
AS proxyMTH LEFT JOIN ReportCYData.dbo.RPT_ASSESSMENT_NUM
ON ReportCYData.dbo.RPT_ASSESSMENT_NUM.SITE_ID = proxyMTH.SITE_ID AND ReportCYData.dbo.RPT_ASSESSMENT_NUM.ASSESSMENT_NAME LIKE proxyMTH.SKILL_DESCRIPTION AND ReportCYData.dbo.RPT_ASSESSMENT_NUM.SCALE LIKE proxyMTH.SCALE_LOCAL AND ReportCYData.dbo.RPT_ASSESSMENT_NUM.INDICATOR_AREA LIKE proxyMTH.INDICATOR_DESC)
AS MY_PROXY_MTHAssess ON (prepost.STUDENT_ID = MY_PROXY_MTHAssess.STUDENT_ID)) ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 5 AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015' AND prepost.ASSESSMENT_TYPE LIKE 'MATH_ASSESS' AND prepost.FISCAL_YEAR LIKE '2014-2015')
AS MTH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;