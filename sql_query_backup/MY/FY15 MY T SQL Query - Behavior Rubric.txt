-- This query sets up data for FY15 mid-year student performance data reporting: Behavior Rubric.
-- Step 1 nests within step 2, which nests within step 3, etc. Replace "*****ABOVE_QUERY*****" with the query text in the preceding step.
-- The final section (QUERY SYNTAX (SINGLE QUERY VERSION)) is the final query that should be set up in a stored procedure in the reporting DB. This step is just a copy of all previous steps, properly nested.


-- QUERY SYNTAX (Restructure behavior rubric data from RPT_PERFORMANCE_LEVEL so that each administration of the rubric is on a single row. Only select non-tagged administration. -- STEP 1)

SELECT behrub.STUDENT_ID, behrub.PERF_DATE, behrub.PROXY_SLF_AWR_PERF_VALUE, behrub.PROXY_SLF_MNG_PERF_VALUE, behrub.PROXY_SCL_AWR_PERF_VALUE, behrub.PROXY_REL_SKL_PERF_VALUE, behrub.PROXY_RES_DCN_MAK_PERF_VALUE,
CASE WHEN behrub.PROXY_SLF_AWR_PERF_VALUE IS NOT NULL AND behrub.PROXY_SLF_MNG_PERF_VALUE IS NOT NULL AND behrub.PROXY_SCL_AWR_PERF_VALUE IS NOT NULL AND behrub.PROXY_REL_SKL_PERF_VALUE IS NOT NULL AND behrub.PROXY_RES_DCN_MAK_PERF_VALUE IS NOT NULL THEN (PROXY_SLF_AWR_PERF_VALUE + PROXY_SLF_MNG_PERF_VALUE + PROXY_SCL_AWR_PERF_VALUE + PROXY_REL_SKL_PERF_VALUE + PROXY_RES_DCN_MAK_PERF_VALUE) / 5.0 ELSE NULL END AS PROXY_AVG_SCORE
FROM
	(SELECT behrub_restruct.STUDENT_ID, behrub_restruct.PERF_DATE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Self Awareness' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SLF_AWR_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Self Management' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SLF_MNG_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Social Awareness' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SCL_AWR_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Relationship Skills' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_REL_SKL_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Responsible Decision Making' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_RES_DCN_MAK_PERF_VALUE
	FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL AS behrub_restruct
	WHERE behrub_restruct.CONFIG_NAME LIKE 'Behavior Rubric' AND behrub_restruct.FISCAL_YEAR LIKE '2014-2015' AND behrub_restruct.Tag IS NULL
	GROUP BY behrub_restruct.STUDENT_ID, behrub_restruct.PERF_DATE)
AS behrub;


-- QUERY SYNTAX (Select the latest non-tagged rubric administration -- BASED ON ABOVE QUERY -- STEP 2):

SELECT behrub1.STUDENT_ID, behrub1.PERF_DATE, behrub1.PROXY_SLF_AWR_PERF_VALUE, behrub1.PROXY_SLF_MNG_PERF_VALUE, behrub1.PROXY_SCL_AWR_PERF_VALUE, behrub1.PROXY_REL_SKL_PERF_VALUE, behrub1.PROXY_RES_DCN_MAK_PERF_VALUE, behrub1.PROXY_AVG_SCORE
FROM
(*****ABOVE_QUERY*****)
AS behrub1 LEFT JOIN
(*****ABOVE_QUERY*****)
AS behrub2 ON behrub1.STUDENT_ID = behrub2.STUDENT_ID AND behrub1.PERF_DATE < behrub2.PERF_DATE
WHERE behrub2.STUDENT_ID IS NULL;


-- QUERY SYNTAX (Merge in columns from RPT_STUDENT_MAIN and RPT_SCHOOL_GRADE, and the selected data points from the queries above, to EVAL_BEH_RUBRIC (pre/post data). Select post/proxy-post data points, where the post data point is selected if available, otherwise use the proxy performance data. Calculate additional MY/EOY variables for reporting. -- BASED ON ABOVE QUERY -- STEP 3):

SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_INTERVAL, prepost.PRE_SLF_AWR_PERF_VALUE, prepost.PRE_SLF_MNG_PERF_VALUE, prepost.PRE_SCL_AWR_PERF_VALUE, prepost.PRE_REL_SKL_PERF_VALUE, prepost.PRE_RES_DCN_MAK_PERF_VALUE, prepost.AVG_PRE_SCORE, prepost.POST_INTERVAL, prepost.POST_SLF_AWR_PERF_VALUE, prepost.POST_SLF_MNG_PERF_VALUE, prepost.POST_SCL_AWR_PERF_VALUE, prepost.POST_REL_SKL_PERF_VALUE, prepost.POST_RES_DCN_MAK_PERF_VALUE, prepost.AVG_POST_SCORE, prepost.AVG_CHANGE_PRE_TO_POST, prepost.CURRENTLY_ENROLLED, prepost.ENROLLED_DAYS, prepost.ENROLLED_DAYS_CATEGORIES, prepost.TTL_TIME, prepost.DOSAGE_CATEGORIES, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, prepost.FISCAL_YEAR, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.ENROLLED_DAYS >= 56 THEN 1 WHEN prepost.ENROLLED_DAYS < 56 THEN 0 ELSE NULL END AS EOY_MET_56_DAYS,
MY_PROXY_BEHRUB.PERF_DATE, MY_PROXY_BEHRUB.PROXY_SLF_AWR_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_SLF_MNG_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_SCL_AWR_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_REL_SKL_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_RES_DCN_MAK_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_AVG_SCORE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_INTERVAL ELSE MY_PROXY_BEHRUB.PERF_DATE END AS MY_INTERVAL,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_SLF_AWR_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_SLF_AWR_PERF_VALUE END AS MY_SLF_AWR_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_SLF_MNG_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_SLF_MNG_PERF_VALUE END AS MY_SLF_MNG_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_SCL_AWR_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_SCL_AWR_PERF_VALUE END AS MY_SCL_AWR_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_REL_SKL_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_REL_SKL_PERF_VALUE END AS MY_REL_SKL_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_RES_DCN_MAK_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_RES_DCN_MAK_PERF_VALUE END AS MY_RES_DCN_MAK_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.AVG_POST_SCORE ELSE MY_PROXY_BEHRUB.PROXY_AVG_SCORE END AS MY_AVG_SCORE
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN (ReportCYData.dbo.EVAL_BEH_RUBRIC AS prepost LEFT JOIN
(*****ABOVE_QUERY*****)
AS MY_PROXY_BEHRUB ON prepost.STUDENT_ID = MY_PROXY_BEHRUB.STUDENT_ID)
ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 2 AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015';


-- QUERY SYNTAX (Re-populate old table, calculate final MY post/proxy-post change variable -- BASED ON ABOVE QUERY -- STEP 4 -- this extra step is required since calculations/joins on new variables can't reference variables that were just created in the same query):

DROP TABLE ImpactAnalytics.dbo.FY15_MY_BEH_RUBRIC_subtable
SELECT BEH_RUB.*,
CASE WHEN BEH_RUB.AVG_PRE_SCORE IS NOT NULL AND BEH_RUB.MY_AVG_SCORE IS NOT NULL THEN BEH_RUB.MY_AVG_SCORE - BEH_RUB.AVG_PRE_SCORE ELSE NULL END AS MY_AVG_SCORE_CHANGE
INTO ImpactAnalytics.dbo.FY15_MY_BEH_RUBRIC_subtable
FROM
(*****ABOVE_QUERY*****)
AS BEH_RUB
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;


-- QUERY SYNTAX (Merge and concatenate -- SINGLE QUERY VERSION):

DROP TABLE ImpactAnalytics.dbo.FY15_MY_BEH_RUBRIC_subtable
SELECT BEH_RUB.*,
CASE WHEN BEH_RUB.AVG_PRE_SCORE IS NOT NULL AND BEH_RUB.MY_AVG_SCORE IS NOT NULL THEN BEH_RUB.MY_AVG_SCORE - BEH_RUB.AVG_PRE_SCORE ELSE NULL END AS MY_AVG_SCORE_CHANGE
INTO ImpactAnalytics.dbo.FY15_MY_BEH_RUBRIC_subtable
FROM
(SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_INTERVAL, prepost.PRE_SLF_AWR_PERF_VALUE, prepost.PRE_SLF_MNG_PERF_VALUE, prepost.PRE_SCL_AWR_PERF_VALUE, prepost.PRE_REL_SKL_PERF_VALUE, prepost.PRE_RES_DCN_MAK_PERF_VALUE, prepost.AVG_PRE_SCORE, prepost.POST_INTERVAL, prepost.POST_SLF_AWR_PERF_VALUE, prepost.POST_SLF_MNG_PERF_VALUE, prepost.POST_SCL_AWR_PERF_VALUE, prepost.POST_REL_SKL_PERF_VALUE, prepost.POST_RES_DCN_MAK_PERF_VALUE, prepost.AVG_POST_SCORE, prepost.AVG_CHANGE_PRE_TO_POST, prepost.CURRENTLY_ENROLLED, prepost.ENROLLED_DAYS, prepost.ENROLLED_DAYS_CATEGORIES, prepost.TTL_TIME, prepost.DOSAGE_CATEGORIES, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, prepost.FISCAL_YEAR, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.ENROLLED_DAYS >= 56 THEN 1 WHEN prepost.ENROLLED_DAYS < 56 THEN 0 ELSE NULL END AS EOY_MET_56_DAYS,
MY_PROXY_BEHRUB.PERF_DATE, MY_PROXY_BEHRUB.PROXY_SLF_AWR_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_SLF_MNG_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_SCL_AWR_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_REL_SKL_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_RES_DCN_MAK_PERF_VALUE, MY_PROXY_BEHRUB.PROXY_AVG_SCORE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_INTERVAL ELSE MY_PROXY_BEHRUB.PERF_DATE END AS MY_INTERVAL,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_SLF_AWR_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_SLF_AWR_PERF_VALUE END AS MY_SLF_AWR_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_SLF_MNG_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_SLF_MNG_PERF_VALUE END AS MY_SLF_MNG_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_SCL_AWR_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_SCL_AWR_PERF_VALUE END AS MY_SCL_AWR_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_REL_SKL_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_REL_SKL_PERF_VALUE END AS MY_REL_SKL_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.POST_RES_DCN_MAK_PERF_VALUE ELSE MY_PROXY_BEHRUB.PROXY_RES_DCN_MAK_PERF_VALUE END AS MY_RES_DCN_MAK_PERF_VALUE,
CASE WHEN prepost.POST_INTERVAL IS NOT NULL THEN prepost.AVG_POST_SCORE ELSE MY_PROXY_BEHRUB.PROXY_AVG_SCORE END AS MY_AVG_SCORE
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN (ReportCYData.dbo.EVAL_BEH_RUBRIC AS prepost LEFT JOIN
(SELECT behrub1.STUDENT_ID, behrub1.PERF_DATE, behrub1.PROXY_SLF_AWR_PERF_VALUE, behrub1.PROXY_SLF_MNG_PERF_VALUE, behrub1.PROXY_SCL_AWR_PERF_VALUE, behrub1.PROXY_REL_SKL_PERF_VALUE, behrub1.PROXY_RES_DCN_MAK_PERF_VALUE, behrub1.PROXY_AVG_SCORE
FROM
(SELECT behrub.STUDENT_ID, behrub.PERF_DATE, behrub.PROXY_SLF_AWR_PERF_VALUE, behrub.PROXY_SLF_MNG_PERF_VALUE, behrub.PROXY_SCL_AWR_PERF_VALUE, behrub.PROXY_REL_SKL_PERF_VALUE, behrub.PROXY_RES_DCN_MAK_PERF_VALUE,
CASE WHEN behrub.PROXY_SLF_AWR_PERF_VALUE IS NOT NULL AND behrub.PROXY_SLF_MNG_PERF_VALUE IS NOT NULL AND behrub.PROXY_SCL_AWR_PERF_VALUE IS NOT NULL AND behrub.PROXY_REL_SKL_PERF_VALUE IS NOT NULL AND behrub.PROXY_RES_DCN_MAK_PERF_VALUE IS NOT NULL THEN (PROXY_SLF_AWR_PERF_VALUE + PROXY_SLF_MNG_PERF_VALUE + PROXY_SCL_AWR_PERF_VALUE + PROXY_REL_SKL_PERF_VALUE + PROXY_RES_DCN_MAK_PERF_VALUE) / 5.0 ELSE NULL END AS PROXY_AVG_SCORE
FROM
	(SELECT behrub_restruct.STUDENT_ID, behrub_restruct.PERF_DATE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Self Awareness' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SLF_AWR_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Self Management' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SLF_MNG_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Social Awareness' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SCL_AWR_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Relationship Skills' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_REL_SKL_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Responsible Decision Making' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_RES_DCN_MAK_PERF_VALUE
	FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL AS behrub_restruct
	WHERE behrub_restruct.CONFIG_NAME LIKE 'Behavior Rubric' AND behrub_restruct.FISCAL_YEAR LIKE '2014-2015' AND behrub_restruct.Tag IS NULL
	GROUP BY behrub_restruct.STUDENT_ID, behrub_restruct.PERF_DATE)
AS behrub)
AS behrub1 LEFT JOIN
(SELECT behrub.STUDENT_ID, behrub.PERF_DATE, behrub.PROXY_SLF_AWR_PERF_VALUE, behrub.PROXY_SLF_MNG_PERF_VALUE, behrub.PROXY_SCL_AWR_PERF_VALUE, behrub.PROXY_REL_SKL_PERF_VALUE, behrub.PROXY_RES_DCN_MAK_PERF_VALUE,
CASE WHEN behrub.PROXY_SLF_AWR_PERF_VALUE IS NOT NULL AND behrub.PROXY_SLF_MNG_PERF_VALUE IS NOT NULL AND behrub.PROXY_SCL_AWR_PERF_VALUE IS NOT NULL AND behrub.PROXY_REL_SKL_PERF_VALUE IS NOT NULL AND behrub.PROXY_RES_DCN_MAK_PERF_VALUE IS NOT NULL THEN (PROXY_SLF_AWR_PERF_VALUE + PROXY_SLF_MNG_PERF_VALUE + PROXY_SCL_AWR_PERF_VALUE + PROXY_REL_SKL_PERF_VALUE + PROXY_RES_DCN_MAK_PERF_VALUE) / 5.0 ELSE NULL END AS PROXY_AVG_SCORE
FROM
	(SELECT behrub_restruct.STUDENT_ID, behrub_restruct.PERF_DATE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Self Awareness' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SLF_AWR_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Self Management' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SLF_MNG_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Social Awareness' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_SCL_AWR_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Relationship Skills' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_REL_SKL_PERF_VALUE,
	AVG(CASE WHEN behrub_restruct.SKILL_DESCRIPTION LIKE 'Responsible Decision Making' THEN behrub_restruct.PERFORMANCE_VALUE_NUMERIC ELSE NULL END) AS PROXY_RES_DCN_MAK_PERF_VALUE
	FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL AS behrub_restruct
	WHERE behrub_restruct.CONFIG_NAME LIKE 'Behavior Rubric' AND behrub_restruct.FISCAL_YEAR LIKE '2014-2015' AND behrub_restruct.Tag IS NULL
	GROUP BY behrub_restruct.STUDENT_ID, behrub_restruct.PERF_DATE)
AS behrub)
AS behrub2 ON behrub1.STUDENT_ID = behrub2.STUDENT_ID AND behrub1.PERF_DATE < behrub2.PERF_DATE
WHERE behrub2.STUDENT_ID IS NULL)
AS MY_PROXY_BEHRUB ON prepost.STUDENT_ID = MY_PROXY_BEHRUB.STUDENT_ID)
ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 2 AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015')
AS BEH_RUB
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;