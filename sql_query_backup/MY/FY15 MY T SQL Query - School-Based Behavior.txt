-- This query sets up data for FY15 mid-year student performance data reporting: School-Based Behavior.
-- Step 1 nests within step 2, which nests within step 3. Replace "*****ABOVE_QUERY*****" with the query text in the preceding step.
-- The final section (QUERY SYNTAX (SINGLE QUERY VERSION)) is the final query that should be set up in a stored procedure in the reporting DB. This step is just a copy of all previous steps, properly nested.


-- QUERY SYNTAX (Calculate marking period-based school-based behavior proxy data point based on marking period behavior data. -- STEP 1.1):

SELECT schbeh1.STUDENT_ID, schbeh1.INTERVAL, schbeh1.OFFICE_REFERRALS, schbeh1.DETENTIONS, schbeh1.SUSPENSIONS
FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL_BEH AS schbeh1 LEFT JOIN ReportCYData.dbo.RPT_PERFORMANCE_LEVEL_BEH AS schbeh2
ON schbeh1.STUDENT_ID = schbeh2.STUDENT_ID AND schbeh1.FREQUENCY_PERIOD_ID < schbeh2.FREQUENCY_PERIOD_ID
WHERE schbeh2.STUDENT_ID IS NULL AND schbeh1.FISCAL_YEAR LIKE '2014-2015' AND schbeh1.INTERVAL NOT LIKE '1st*' AND schbeh1.Tag IS NULL AND (schbeh1.INTERVAL LIKE '%Semester' OR schbeh1.INTERVAL LIKE '%Trimester' OR schbeh1.INTERVAL LIKE '%Quarter' OR schbeh1.INTERVAL LIKE '%Marking Period');


-- QUERY SYNTAX (Calculate DJFM school-based behavior proxy data point based on monthly behavior data. Only calculate proxy data point if there is at least two months worth of data. -- STEP 1.2):

SELECT schbeh12.STUDENT_ID, COUNT(schbeh12.OFFICE_REFERRALS) AS countOFF, COUNT(schbeh12.DETENTIONS) AS countDET, COUNT(schbeh12.SUSPENSIONS) AS countSUS,
CASE WHEN COUNT(schbeh12.OFFICE_REFERRALS) >= 2 THEN SUM(schbeh12.OFFICE_REFERRALS) ELSE NULL END AS sumOFF,
CASE WHEN COUNT(schbeh12.DETENTIONS) >= 2 THEN SUM(schbeh12.DETENTIONS) ELSE NULL END AS sumDET,
CASE WHEN COUNT(schbeh12.SUSPENSIONS) >= 2 THEN SUM(schbeh12.SUSPENSIONS) ELSE NULL END AS sumSUS
FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL_BEH AS schbeh12
WHERE (schbeh12.INTERVAL LIKE 'Dec' OR schbeh12.INTERVAL LIKE 'Jan' OR schbeh12.INTERVAL LIKE 'Feb' OR schbeh12.INTERVAL LIKE 'Mar') AND schbeh12.Tag IS NULL AND schbeh12.FISCAL_YEAR LIKE '2014-2015'
GROUP BY schbeh12.STUDENT_ID;


-- QUERY SYNTAX (Merge in columns from RPT_STUDENT_MAIN, RPT_SCHOOL_GRADE, and the selected data points from the queries above, to EVAL_BEH (pre/post data). Select post/proxy-post data points, where the post data point is selected if available, otherwise use the proxy performance data. Calculate additional MY/EOY variables for reporting. -- BASED ON ABOVE QUERY -- STEP 2):

SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_BEH_VALUE, prepost.PRE_BEH_SUS, prepost.PRE_BEH_SUS_DESC, prepost.PRE_BEH_DET, prepost.PRE_BEH_DET_DESC, prepost.PRE_BEH_OFF, prepost.PRE_BEH_OFF_DESC, prepost.PRE_SCENARIO, prepost.POST_BEH_VALUE, prepost.POST_BEH_SUS, prepost.POST_BEH_SUS_DESC, prepost.POST_BEH_DET, prepost.POST_BEH_DET_DESC, prepost.POST_BEH_OFF, prepost.POST_BEH_OFF_DESC, prepost.POST_SCENARIO, prepost.ENROLLED_DAYS, prepost.ENROLLED_DAYS_CATEGORIES, prepost.TTL_TIME, prepost.DOSAGE_CATEGORIES, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.ENROLLED_DAYS >= 56 THEN 1 WHEN prepost.ENROLLED_DAYS < 56 THEN 0 ELSE NULL END AS EOY_MET_56_DAYS,
CASE WHEN prepost.PRE_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.PRE_BEH_OFF < 5 THEN CAST(prepost.PRE_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.PRE_BEH_OFF >= 5 AND prepost.PRE_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.PRE_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS PRE_BEH_OFF_CAT,
CASE WHEN prepost.PRE_BEH_DET = 1 THEN '1 detention' WHEN prepost.PRE_BEH_DET < 5 THEN CAST(prepost.PRE_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.PRE_BEH_DET >= 5 AND prepost.PRE_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.PRE_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS PRE_BEH_DET_CAT,
CASE WHEN prepost.PRE_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.PRE_BEH_SUS < 5 THEN CAST(prepost.PRE_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.PRE_BEH_SUS >= 5 AND prepost.PRE_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.PRE_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS PRE_BEH_SUS_CAT,
CASE WHEN prepost.POST_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.POST_BEH_OFF < 5 THEN CAST(prepost.POST_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.POST_BEH_OFF >= 5 AND prepost.POST_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.POST_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS POST_BEH_OFF_CAT,
CASE WHEN prepost.POST_BEH_DET = 1 THEN '1 detention' WHEN prepost.POST_BEH_DET < 5 THEN CAST(prepost.POST_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.POST_BEH_DET >= 5 AND prepost.POST_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.POST_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS POST_BEH_DET_CAT,
CASE WHEN prepost.POST_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.POST_BEH_SUS < 5 THEN CAST(prepost.POST_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.POST_BEH_SUS >= 5 AND prepost.POST_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.POST_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS POST_BEH_SUS_CAT,
CASE WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF > 0 THEN 'Increased' WHEN prepost.PRE_BEH_OFF = 0 and prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromZero,
CASE WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET > 0 THEN 'Increased' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromZero,
CASE WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS > 0 THEN 'Increased' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromZero,
CASE WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF > prepost.POST_BEH_OFF THEN 'Decreased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF = prepost.POST_BEH_OFF THEN 'No change' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF < prepost.POST_BEH_OFF THEN 'Increased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromGTZero,
CASE WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET > prepost.POST_BEH_DET THEN 'Decreased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET = prepost.POST_BEH_DET THEN 'No change' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET < prepost.POST_BEH_DET THEN 'Increased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromGTZero,
CASE WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS > prepost.POST_BEH_SUS THEN 'Decreased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS = prepost.POST_BEH_SUS THEN 'No change' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS < prepost.POST_BEH_SUS THEN 'Increased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromGTZero,
MY_PROXY_BEHMP.INTERVAL AS PROXY_BEHMP_VALUE, MY_PROXY_BEHMP.OFFICE_REFERRALS AS PROXY_BEHMP_OFF, MY_PROXY_BEHMP.DETENTIONS AS PROXY_BEHMP_DET, MY_PROXY_BEHMP.SUSPENSIONS AS PROXY_BEHMP_SUS, MY_PROXY_BEHDJFM.sumOFF AS PROXY_BEHDJFM_OFF, MY_PROXY_BEHDJFM.sumDET AS PROXY_BEHDJFM_DET, MY_PROXY_BEHDJFM.sumSUS AS PROXY_BEHDJFM_SUS,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN 'DJFM' WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.INTERVAL ELSE prepost.POST_BEH_VALUE END AS MY_BEH_VALUE,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN MY_PROXY_BEHDJFM.sumOFF WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.OFFICE_REFERRALS ELSE prepost.POST_BEH_OFF END AS MY_BEH_OFF,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN MY_PROXY_BEHDJFM.sumDET WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.DETENTIONS ELSE prepost.POST_BEH_DET END AS MY_BEH_DET,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN MY_PROXY_BEHDJFM.sumSUS WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.SUSPENSIONS ELSE prepost.POST_BEH_SUS END AS MY_BEH_SUS
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN ((ReportCYData.dbo.EVAL_BEH AS prepost LEFT JOIN
(*****ABOVE_QUERY 1.1 Marking Period*****)
AS MY_PROXY_BEHMP ON (prepost.STUDENT_ID = MY_PROXY_BEHMP.STUDENT_ID))
LEFT JOIN
(*****ABOVE_QUERY 1.2 DJFM*****)
AS MY_PROXY_BEHDJFM ON (prepost.STUDENT_ID = MY_PROXY_BEHDJFM.STUDENT_ID))
ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 2 AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015';


-- QUERY SYNTAX (Calculate additional post/proxy-post variables -- BASED ON ABOVE QUERY -- STEP 3 -- this extra step is required since calculations on new variables can't reference variables that were just created in the same query):

SELECT MY_PROXY_BEHSCH.SITE_NAME, MY_PROXY_BEHSCH.SCHOOL_NAME, MY_PROXY_BEHSCH.GRADE_ID, MY_PROXY_BEHSCH.DIPLOMAS_NOW_SCHOOL, MY_PROXY_BEHSCH.STUDENT_ID, MY_PROXY_BEHSCH.SCHOOL_ID, MY_PROXY_BEHSCH.PRE_BEH_VALUE, MY_PROXY_BEHSCH.PRE_BEH_SUS, MY_PROXY_BEHSCH.PRE_BEH_SUS_DESC, MY_PROXY_BEHSCH.PRE_BEH_DET, MY_PROXY_BEHSCH.PRE_BEH_DET_DESC, MY_PROXY_BEHSCH.PRE_BEH_OFF, MY_PROXY_BEHSCH.PRE_BEH_OFF_DESC, MY_PROXY_BEHSCH.PRE_SCENARIO, MY_PROXY_BEHSCH.POST_BEH_VALUE, MY_PROXY_BEHSCH.POST_BEH_SUS, MY_PROXY_BEHSCH.POST_BEH_SUS_DESC, MY_PROXY_BEHSCH.POST_BEH_DET, MY_PROXY_BEHSCH.POST_BEH_DET_DESC, MY_PROXY_BEHSCH.POST_BEH_OFF, MY_PROXY_BEHSCH.POST_BEH_OFF_DESC, MY_PROXY_BEHSCH.POST_SCENARIO, MY_PROXY_BEHSCH.ENROLLED_DAYS, MY_PROXY_BEHSCH.ENROLLED_DAYS_CATEGORIES, MY_PROXY_BEHSCH.TTL_TIME, MY_PROXY_BEHSCH.DOSAGE_CATEGORIES, MY_PROXY_BEHSCH.Attendance_IA, MY_PROXY_BEHSCH.ELA_IA, MY_PROXY_BEHSCH.Math_IA, MY_PROXY_BEHSCH.Behavior_IA, MY_PROXY_BEHSCH.INDICATOR_ID, MY_PROXY_BEHSCH.B_RULE_VAL1, MY_PROXY_BEHSCH.B_RULE_VAL2, MY_PROXY_BEHSCH.B_RULE_VAL3, MY_PROXY_BEHSCH.B_RULE_VAL4, MY_PROXY_BEHSCH.B_RULE_VAL5, MY_PROXY_BEHSCH.GRADE_ID_RECODE, MY_PROXY_BEHSCH.EOY_MET_56_DAYS, MY_PROXY_BEHSCH.PRE_BEH_OFF_CAT, MY_PROXY_BEHSCH.PRE_BEH_DET_CAT, MY_PROXY_BEHSCH.PRE_BEH_SUS_CAT, MY_PROXY_BEHSCH.POST_BEH_OFF_CAT, MY_PROXY_BEHSCH.POST_BEH_DET_CAT, MY_PROXY_BEHSCH.POST_BEH_SUS_CAT, MY_PROXY_BEHSCH.EOY_OFF_FromZero, MY_PROXY_BEHSCH.EOY_DET_FromZero, MY_PROXY_BEHSCH.EOY_SUS_FromZero, MY_PROXY_BEHSCH.EOY_OFF_FromGTZero, MY_PROXY_BEHSCH.EOY_DET_FromGTZero, MY_PROXY_BEHSCH.EOY_SUS_FromGTZero, MY_PROXY_BEHSCH.PROXY_BEHMP_VALUE, MY_PROXY_BEHSCH.PROXY_BEHMP_OFF, MY_PROXY_BEHSCH.PROXY_BEHMP_DET, MY_PROXY_BEHSCH.PROXY_BEHMP_SUS, MY_PROXY_BEHSCH.PROXY_BEHDJFM_OFF, MY_PROXY_BEHSCH.PROXY_BEHDJFM_DET, MY_PROXY_BEHSCH.PROXY_BEHDJFM_SUS, MY_PROXY_BEHSCH.MY_BEH_VALUE, MY_PROXY_BEHSCH.MY_BEH_OFF, MY_PROXY_BEHSCH.MY_BEH_DET, MY_PROXY_BEHSCH.MY_BEH_SUS,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_OFF = 1 THEN '1 office referral' WHEN MY_PROXY_BEHSCH.MY_BEH_OFF < 5 THEN CAST(MY_PROXY_BEHSCH.MY_BEH_OFF AS VARCHAR) + ' office referrals' WHEN MY_PROXY_BEHSCH.MY_BEH_OFF < 11 THEN '5-10 office referrals' WHEN MY_PROXY_BEHSCH.MY_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS MY_BEH_OFF_CAT,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_DET = 1 THEN '1 detention' WHEN MY_PROXY_BEHSCH.MY_BEH_DET < 5 THEN CAST(MY_PROXY_BEHSCH.MY_BEH_DET AS VARCHAR) + ' detentions' WHEN MY_PROXY_BEHSCH.MY_BEH_DET < 11 THEN '5-10 detentions' WHEN MY_PROXY_BEHSCH.MY_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS MY_BEH_DET_CAT,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_SUS = 1 THEN '1 suspension' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS < 5 THEN CAST(MY_PROXY_BEHSCH.MY_BEH_SUS AS VARCHAR) + ' suspensions' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS < 11 THEN '5-10 suspensions' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS MY_BEH_SUS_CAT,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF = 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF = 0 THEN 'Maintained (Prevention)' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF = 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF > 0 THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF = 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_OFF_FromZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_DET = 0 AND MY_PROXY_BEHSCH.MY_BEH_DET = 0 THEN 'Maintained (Prevention)' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET = 0 AND MY_PROXY_BEHSCH.MY_BEH_DET > 0 THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET = 0 AND MY_PROXY_BEHSCH.MY_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_DET_FromZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS = 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS = 0 THEN 'Maintained (Prevention)' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS = 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS > 0 THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS = 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_SUS_FromZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.PRE_BEH_OFF > MY_PROXY_BEHSCH.MY_BEH_OFF THEN 'Decreased' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.PRE_BEH_OFF = MY_PROXY_BEHSCH.MY_BEH_OFF THEN 'No change' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.PRE_BEH_OFF < MY_PROXY_BEHSCH.MY_BEH_OFF THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_OFF_FromGTZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.PRE_BEH_DET > MY_PROXY_BEHSCH.MY_BEH_DET THEN 'Decreased' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.PRE_BEH_DET = MY_PROXY_BEHSCH.MY_BEH_DET THEN 'No change' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.PRE_BEH_DET < MY_PROXY_BEHSCH.MY_BEH_DET THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.MY_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_DET_FromGTZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.PRE_BEH_SUS > MY_PROXY_BEHSCH.MY_BEH_SUS THEN 'Decreased' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.PRE_BEH_SUS = MY_PROXY_BEHSCH.MY_BEH_SUS THEN 'No change' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.PRE_BEH_SUS < MY_PROXY_BEHSCH.MY_BEH_SUS THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_SUS_FromGTZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS < 2 THEN 'Pre-data point: less than 2 suspensions' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS >= 2 THEN 'Pre-data point: 2 or more suspensions' ELSE NULL END AS PRE_EWI,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_SUS < 2 THEN 'Post/proxy-post data point: less than 2 suspensions' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS >= 2 THEN 'Post/proxy-post data point: 2 or more suspensions' ELSE NULL END AS MY_EWI,
CASE WHEN MY_PROXY_BEHSCH.POST_BEH_SUS < 2 THEN 'Post-data point: less than 2 suspensions' WHEN MY_PROXY_BEHSCH.POST_BEH_SUS >= 2 THEN 'Post-data point: 2 or more suspensions' ELSE NULL END AS POST_EWI
FROM
(*****ABOVE_QUERY*****)
AS MY_PROXY_BEHSCH;


-- QUERY SYNTAX (Re-populate old table, calculate final MY/EOY post/proxy-post change variables -- BASED ON ABOVE QUERY -- STEP 4 -- this extra step is required since calculations/joins on new variables can't reference variables that were just created in the same query):

DROP TABLE ImpactAnalytics.dbo.FY15_MY_BEH_SCHOOL_BASED_subtable
SELECT BEH.*,
CASE WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.MY_EWI LIKE '%less than 2 suspensions' THEN 'Started with no EWI, maintained no EWI' WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.MY_EWI LIKE '%2 or more suspensions' THEN 'Started with no EWI, EWI at mid-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.MY_EWI LIKE '%less than 2 suspensions' THEN 'Started with EWI, no EWI at mid-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.MY_EWI LIKE '%2 or more suspensions' THEN 'Started with EWI, EWI at mid-year' ELSE NULL END AS MY_EWI_CHANGE,
CASE WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.POST_EWI LIKE '%less than 2 suspensions' THEN 'Started with no EWI, maintained no EWI' WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.POST_EWI LIKE '%2 or more suspensions' THEN 'Started with no EWI, EWI at end-of-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.POST_EWI LIKE '%less than 2 suspensions' THEN 'Started with EWI, no EWI at end-of-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.POST_EWI LIKE '%2 or more suspensions' THEN 'Started with EWI, EWI at end-of-year' ELSE NULL END AS POST_EWI_CHANGE
INTO ImpactAnalytics.dbo.FY15_MY_BEH_SCHOOL_BASED_subtable
FROM
(*****ABOVE_QUERY*****)
AS BEH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;


-- QUERY SYNTAX (Merge and concatenate - SINGLE QUERY VERSION)

DROP TABLE ImpactAnalytics.dbo.FY15_MY_BEH_SCHOOL_BASED_subtable
SELECT BEH.*,
CASE WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.MY_EWI LIKE '%less than 2 suspensions' THEN 'Started with no EWI, maintained no EWI' WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.MY_EWI LIKE '%2 or more suspensions' THEN 'Started with no EWI, EWI at mid-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.MY_EWI LIKE '%less than 2 suspensions' THEN 'Started with EWI, no EWI at mid-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.MY_EWI LIKE '%2 or more suspensions' THEN 'Started with EWI, EWI at mid-year' ELSE NULL END AS MY_EWI_CHANGE,
CASE WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.POST_EWI LIKE '%less than 2 suspensions' THEN 'Started with no EWI, maintained no EWI' WHEN BEH.PRE_EWI LIKE '%less than 2 suspensions' AND BEH.POST_EWI LIKE '%2 or more suspensions' THEN 'Started with no EWI, EWI at end-of-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.POST_EWI LIKE '%less than 2 suspensions' THEN 'Started with EWI, no EWI at end-of-year' WHEN BEH.PRE_EWI LIKE '%2 or more suspensions' AND BEH.POST_EWI LIKE '%2 or more suspensions' THEN 'Started with EWI, EWI at end-of-year' ELSE NULL END AS POST_EWI_CHANGE
INTO ImpactAnalytics.dbo.FY15_MY_BEH_SCHOOL_BASED_subtable
FROM
(SELECT MY_PROXY_BEHSCH.SITE_NAME, MY_PROXY_BEHSCH.SCHOOL_NAME, MY_PROXY_BEHSCH.GRADE_ID, MY_PROXY_BEHSCH.DIPLOMAS_NOW_SCHOOL, MY_PROXY_BEHSCH.STUDENT_ID, MY_PROXY_BEHSCH.SCHOOL_ID, MY_PROXY_BEHSCH.PRE_BEH_VALUE, MY_PROXY_BEHSCH.PRE_BEH_SUS, MY_PROXY_BEHSCH.PRE_BEH_SUS_DESC, MY_PROXY_BEHSCH.PRE_BEH_DET, MY_PROXY_BEHSCH.PRE_BEH_DET_DESC, MY_PROXY_BEHSCH.PRE_BEH_OFF, MY_PROXY_BEHSCH.PRE_BEH_OFF_DESC, MY_PROXY_BEHSCH.PRE_SCENARIO, MY_PROXY_BEHSCH.POST_BEH_VALUE, MY_PROXY_BEHSCH.POST_BEH_SUS, MY_PROXY_BEHSCH.POST_BEH_SUS_DESC, MY_PROXY_BEHSCH.POST_BEH_DET, MY_PROXY_BEHSCH.POST_BEH_DET_DESC, MY_PROXY_BEHSCH.POST_BEH_OFF, MY_PROXY_BEHSCH.POST_BEH_OFF_DESC, MY_PROXY_BEHSCH.POST_SCENARIO, MY_PROXY_BEHSCH.ENROLLED_DAYS, MY_PROXY_BEHSCH.ENROLLED_DAYS_CATEGORIES, MY_PROXY_BEHSCH.TTL_TIME, MY_PROXY_BEHSCH.DOSAGE_CATEGORIES, MY_PROXY_BEHSCH.Attendance_IA, MY_PROXY_BEHSCH.ELA_IA, MY_PROXY_BEHSCH.Math_IA, MY_PROXY_BEHSCH.Behavior_IA, MY_PROXY_BEHSCH.INDICATOR_ID, MY_PROXY_BEHSCH.B_RULE_VAL1, MY_PROXY_BEHSCH.B_RULE_VAL2, MY_PROXY_BEHSCH.B_RULE_VAL3, MY_PROXY_BEHSCH.B_RULE_VAL4, MY_PROXY_BEHSCH.B_RULE_VAL5, MY_PROXY_BEHSCH.GRADE_ID_RECODE, MY_PROXY_BEHSCH.EOY_MET_56_DAYS, MY_PROXY_BEHSCH.PRE_BEH_OFF_CAT, MY_PROXY_BEHSCH.PRE_BEH_DET_CAT, MY_PROXY_BEHSCH.PRE_BEH_SUS_CAT, MY_PROXY_BEHSCH.POST_BEH_OFF_CAT, MY_PROXY_BEHSCH.POST_BEH_DET_CAT, MY_PROXY_BEHSCH.POST_BEH_SUS_CAT, MY_PROXY_BEHSCH.EOY_OFF_FromZero, MY_PROXY_BEHSCH.EOY_DET_FromZero, MY_PROXY_BEHSCH.EOY_SUS_FromZero, MY_PROXY_BEHSCH.EOY_OFF_FromGTZero, MY_PROXY_BEHSCH.EOY_DET_FromGTZero, MY_PROXY_BEHSCH.EOY_SUS_FromGTZero, MY_PROXY_BEHSCH.PROXY_BEHMP_VALUE, MY_PROXY_BEHSCH.PROXY_BEHMP_OFF, MY_PROXY_BEHSCH.PROXY_BEHMP_DET, MY_PROXY_BEHSCH.PROXY_BEHMP_SUS, MY_PROXY_BEHSCH.PROXY_BEHDJFM_OFF, MY_PROXY_BEHSCH.PROXY_BEHDJFM_DET, MY_PROXY_BEHSCH.PROXY_BEHDJFM_SUS, MY_PROXY_BEHSCH.MY_BEH_VALUE, MY_PROXY_BEHSCH.MY_BEH_OFF, MY_PROXY_BEHSCH.MY_BEH_DET, MY_PROXY_BEHSCH.MY_BEH_SUS,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_OFF = 1 THEN '1 office referral' WHEN MY_PROXY_BEHSCH.MY_BEH_OFF < 5 THEN CAST(MY_PROXY_BEHSCH.MY_BEH_OFF AS VARCHAR) + ' office referrals' WHEN MY_PROXY_BEHSCH.MY_BEH_OFF < 11 THEN '5-10 office referrals' WHEN MY_PROXY_BEHSCH.MY_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS MY_BEH_OFF_CAT,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_DET = 1 THEN '1 detention' WHEN MY_PROXY_BEHSCH.MY_BEH_DET < 5 THEN CAST(MY_PROXY_BEHSCH.MY_BEH_DET AS VARCHAR) + ' detentions' WHEN MY_PROXY_BEHSCH.MY_BEH_DET < 11 THEN '5-10 detentions' WHEN MY_PROXY_BEHSCH.MY_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS MY_BEH_DET_CAT,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_SUS = 1 THEN '1 suspension' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS < 5 THEN CAST(MY_PROXY_BEHSCH.MY_BEH_SUS AS VARCHAR) + ' suspensions' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS < 11 THEN '5-10 suspensions' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS MY_BEH_SUS_CAT,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF = 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF = 0 THEN 'Maintained (Prevention)' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF = 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF > 0 THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF = 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_OFF_FromZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_DET = 0 AND MY_PROXY_BEHSCH.MY_BEH_DET = 0 THEN 'Maintained (Prevention)' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET = 0 AND MY_PROXY_BEHSCH.MY_BEH_DET > 0 THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET = 0 AND MY_PROXY_BEHSCH.MY_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_DET_FromZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS = 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS = 0 THEN 'Maintained (Prevention)' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS = 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS > 0 THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS = 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_SUS_FromZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.PRE_BEH_OFF > MY_PROXY_BEHSCH.MY_BEH_OFF THEN 'Decreased' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.PRE_BEH_OFF = MY_PROXY_BEHSCH.MY_BEH_OFF THEN 'No change' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.PRE_BEH_OFF < MY_PROXY_BEHSCH.MY_BEH_OFF THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_OFF > 0 AND MY_PROXY_BEHSCH.MY_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_OFF_FromGTZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.PRE_BEH_DET > MY_PROXY_BEHSCH.MY_BEH_DET THEN 'Decreased' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.PRE_BEH_DET = MY_PROXY_BEHSCH.MY_BEH_DET THEN 'No change' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.PRE_BEH_DET < MY_PROXY_BEHSCH.MY_BEH_DET THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_DET > 0 AND MY_PROXY_BEHSCH.MY_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_DET_FromGTZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.PRE_BEH_SUS > MY_PROXY_BEHSCH.MY_BEH_SUS THEN 'Decreased' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.PRE_BEH_SUS = MY_PROXY_BEHSCH.MY_BEH_SUS THEN 'No change' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.PRE_BEH_SUS < MY_PROXY_BEHSCH.MY_BEH_SUS THEN 'Increased' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS > 0 AND MY_PROXY_BEHSCH.MY_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS MY_SUS_FromGTZero,
CASE WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS < 2 THEN 'Pre-data point: less than 2 suspensions' WHEN MY_PROXY_BEHSCH.PRE_BEH_SUS >= 2 THEN 'Pre-data point: 2 or more suspensions' ELSE NULL END AS PRE_EWI,
CASE WHEN MY_PROXY_BEHSCH.MY_BEH_SUS < 2 THEN 'Post/proxy-post data point: less than 2 suspensions' WHEN MY_PROXY_BEHSCH.MY_BEH_SUS >= 2 THEN 'Post/proxy-post data point: 2 or more suspensions' ELSE NULL END AS MY_EWI,
CASE WHEN MY_PROXY_BEHSCH.POST_BEH_SUS < 2 THEN 'Post-data point: less than 2 suspensions' WHEN MY_PROXY_BEHSCH.POST_BEH_SUS >= 2 THEN 'Post-data point: 2 or more suspensions' ELSE NULL END AS POST_EWI
FROM
(SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_BEH_VALUE, prepost.PRE_BEH_SUS, prepost.PRE_BEH_SUS_DESC, prepost.PRE_BEH_DET, prepost.PRE_BEH_DET_DESC, prepost.PRE_BEH_OFF, prepost.PRE_BEH_OFF_DESC, prepost.PRE_SCENARIO, prepost.POST_BEH_VALUE, prepost.POST_BEH_SUS, prepost.POST_BEH_SUS_DESC, prepost.POST_BEH_DET, prepost.POST_BEH_DET_DESC, prepost.POST_BEH_OFF, prepost.POST_BEH_OFF_DESC, prepost.POST_SCENARIO, prepost.ENROLLED_DAYS, prepost.ENROLLED_DAYS_CATEGORIES, prepost.TTL_TIME, prepost.DOSAGE_CATEGORIES, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.ENROLLED_DAYS >= 56 THEN 1 WHEN prepost.ENROLLED_DAYS < 56 THEN 0 ELSE NULL END AS EOY_MET_56_DAYS,
CASE WHEN prepost.PRE_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.PRE_BEH_OFF < 5 THEN CAST(prepost.PRE_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.PRE_BEH_OFF >= 5 AND prepost.PRE_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.PRE_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS PRE_BEH_OFF_CAT,
CASE WHEN prepost.PRE_BEH_DET = 1 THEN '1 detention' WHEN prepost.PRE_BEH_DET < 5 THEN CAST(prepost.PRE_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.PRE_BEH_DET >= 5 AND prepost.PRE_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.PRE_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS PRE_BEH_DET_CAT,
CASE WHEN prepost.PRE_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.PRE_BEH_SUS < 5 THEN CAST(prepost.PRE_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.PRE_BEH_SUS >= 5 AND prepost.PRE_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.PRE_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS PRE_BEH_SUS_CAT,
CASE WHEN prepost.POST_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.POST_BEH_OFF < 5 THEN CAST(prepost.POST_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.POST_BEH_OFF >= 5 AND prepost.POST_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.POST_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS POST_BEH_OFF_CAT,
CASE WHEN prepost.POST_BEH_DET = 1 THEN '1 detention' WHEN prepost.POST_BEH_DET < 5 THEN CAST(prepost.POST_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.POST_BEH_DET >= 5 AND prepost.POST_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.POST_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS POST_BEH_DET_CAT,
CASE WHEN prepost.POST_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.POST_BEH_SUS < 5 THEN CAST(prepost.POST_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.POST_BEH_SUS >= 5 AND prepost.POST_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.POST_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS POST_BEH_SUS_CAT,
CASE WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF > 0 THEN 'Increased' WHEN prepost.PRE_BEH_OFF = 0 and prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromZero,
CASE WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET > 0 THEN 'Increased' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromZero,
CASE WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS > 0 THEN 'Increased' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromZero,
CASE WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF > prepost.POST_BEH_OFF THEN 'Decreased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF = prepost.POST_BEH_OFF THEN 'No change' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF < prepost.POST_BEH_OFF THEN 'Increased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromGTZero,
CASE WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET > prepost.POST_BEH_DET THEN 'Decreased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET = prepost.POST_BEH_DET THEN 'No change' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET < prepost.POST_BEH_DET THEN 'Increased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromGTZero,
CASE WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS > prepost.POST_BEH_SUS THEN 'Decreased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS = prepost.POST_BEH_SUS THEN 'No change' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS < prepost.POST_BEH_SUS THEN 'Increased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromGTZero,
MY_PROXY_BEHMP.INTERVAL AS PROXY_BEHMP_VALUE, MY_PROXY_BEHMP.OFFICE_REFERRALS AS PROXY_BEHMP_OFF, MY_PROXY_BEHMP.DETENTIONS AS PROXY_BEHMP_DET, MY_PROXY_BEHMP.SUSPENSIONS AS PROXY_BEHMP_SUS, MY_PROXY_BEHDJFM.sumOFF AS PROXY_BEHDJFM_OFF, MY_PROXY_BEHDJFM.sumDET AS PROXY_BEHDJFM_DET, MY_PROXY_BEHDJFM.sumSUS AS PROXY_BEHDJFM_SUS,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN 'DJFM' WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.INTERVAL ELSE prepost.POST_BEH_VALUE END AS MY_BEH_VALUE,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN MY_PROXY_BEHDJFM.sumOFF WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.OFFICE_REFERRALS ELSE prepost.POST_BEH_OFF END AS MY_BEH_OFF,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN MY_PROXY_BEHDJFM.sumDET WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.DETENTIONS ELSE prepost.POST_BEH_DET END AS MY_BEH_DET,
CASE WHEN prepost.POST_BEH_VALUE IS NULL AND prepost.PRE_BEH_VALUE LIKE 'ASON' THEN MY_PROXY_BEHDJFM.sumSUS WHEN prepost.POST_BEH_VALUE IS NULL AND (prepost.PRE_BEH_VALUE LIKE '%Semester' OR prepost.PRE_BEH_VALUE LIKE '%Trimester' OR prepost.PRE_BEH_VALUE LIKE '%Quarter' OR prepost.PRE_BEH_VALUE LIKE '%Marking Period') THEN MY_PROXY_BEHMP.SUSPENSIONS ELSE prepost.POST_BEH_SUS END AS MY_BEH_SUS
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN ((ReportCYData.dbo.EVAL_BEH AS prepost LEFT JOIN
(SELECT schbeh1.STUDENT_ID, schbeh1.INTERVAL, schbeh1.OFFICE_REFERRALS, schbeh1.DETENTIONS, schbeh1.SUSPENSIONS
FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL_BEH AS schbeh1 LEFT JOIN ReportCYData.dbo.RPT_PERFORMANCE_LEVEL_BEH AS schbeh2
ON schbeh1.STUDENT_ID = schbeh2.STUDENT_ID AND schbeh1.FREQUENCY_PERIOD_ID < schbeh2.FREQUENCY_PERIOD_ID
WHERE schbeh2.STUDENT_ID IS NULL AND schbeh1.FISCAL_YEAR LIKE '2014-2015' AND schbeh1.INTERVAL NOT LIKE '1st*' AND schbeh1.Tag IS NULL AND (schbeh1.INTERVAL LIKE '%Semester' OR schbeh1.INTERVAL LIKE '%Trimester' OR schbeh1.INTERVAL LIKE '%Quarter' OR schbeh1.INTERVAL LIKE '%Marking Period'))
AS MY_PROXY_BEHMP ON (prepost.STUDENT_ID = MY_PROXY_BEHMP.STUDENT_ID))
LEFT JOIN
(SELECT schbeh12.STUDENT_ID, COUNT(schbeh12.OFFICE_REFERRALS) AS countOFF, COUNT(schbeh12.DETENTIONS) AS countDET, COUNT(schbeh12.SUSPENSIONS) AS countSUS,
CASE WHEN COUNT(schbeh12.OFFICE_REFERRALS) >= 2 THEN SUM(schbeh12.OFFICE_REFERRALS) ELSE NULL END AS sumOFF,
CASE WHEN COUNT(schbeh12.DETENTIONS) >= 2 THEN SUM(schbeh12.DETENTIONS) ELSE NULL END AS sumDET,
CASE WHEN COUNT(schbeh12.SUSPENSIONS) >= 2 THEN SUM(schbeh12.SUSPENSIONS) ELSE NULL END AS sumSUS
FROM ReportCYData.dbo.RPT_PERFORMANCE_LEVEL_BEH AS schbeh12
WHERE (schbeh12.INTERVAL LIKE 'Dec' OR schbeh12.INTERVAL LIKE 'Jan' OR schbeh12.INTERVAL LIKE 'Feb' OR schbeh12.INTERVAL LIKE 'Mar') AND schbeh12.Tag IS NULL AND schbeh12.FISCAL_YEAR LIKE '2014-2015'
GROUP BY schbeh12.STUDENT_ID)
AS MY_PROXY_BEHDJFM ON (prepost.STUDENT_ID = MY_PROXY_BEHDJFM.STUDENT_ID))
ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 2 AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015')
AS MY_PROXY_BEHSCH)
AS BEH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;