-- These queries set up data for start-of-year student performance data reporting.

-- QUERY SYNTAX (Merge in columns from RPT_STUDENT_MAIN and RPT_SCHOOL_GRADE -- STEP 1):

SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_BEH_VALUE, prepost.PRE_BEH_SUS, prepost.PRE_BEH_SUS_DESC, prepost.PRE_BEH_DET, prepost.PRE_BEH_DET_DESC, prepost.PRE_BEH_OFF, prepost.PRE_BEH_OFF_DESC, prepost.PRE_SCENARIO, prepost.POST_BEH_VALUE, prepost.POST_BEH_SUS, prepost.POST_BEH_SUS_DESC, prepost.POST_BEH_DET, prepost.POST_BEH_DET_DESC, prepost.POST_BEH_OFF, prepost.POST_BEH_OFF_DESC, prepost.POST_SCENARIO, prepost.ENROLLED_DAYS, prepost.ENROLLED_DAYS_CATEGORIES, prepost.TTL_TIME, prepost.DOSAGE_CATEGORIES, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.ENROLLED_DAYS >= 56 THEN 1 WHEN prepost.ENROLLED_DAYS < 56 THEN 0 ELSE NULL END AS EOY_MET_56_DAYS,
CASE WHEN prepost.PRE_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.PRE_BEH_OFF < 5 THEN CAST(prepost.PRE_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.PRE_BEH_OFF >= 5 AND prepost.PRE_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.PRE_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS PRE_BEH_OFF_CAT,
CASE WHEN prepost.PRE_BEH_DET = 1 THEN '1 detention' WHEN prepost.PRE_BEH_DET < 5 THEN CAST(prepost.PRE_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.PRE_BEH_DET >= 5 AND prepost.PRE_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.PRE_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS PRE_BEH_DET_CAT,
CASE WHEN prepost.PRE_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.PRE_BEH_SUS < 5 THEN CAST(prepost.PRE_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.PRE_BEH_SUS >= 5 AND prepost.PRE_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.PRE_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS PRE_BEH_SUS_CAT,
CASE WHEN prepost.POST_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.POST_BEH_OFF < 5 THEN CAST(prepost.POST_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.POST_BEH_OFF >= 5 AND prepost.POST_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.POST_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS POST_BEH_OFF_CAT,
CASE WHEN prepost.POST_BEH_DET = 1 THEN '1 detention' WHEN prepost.POST_BEH_DET < 5 THEN CAST(prepost.POST_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.POST_BEH_DET >= 5 AND prepost.POST_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.POST_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS POST_BEH_DET_CAT,
CASE WHEN prepost.POST_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.POST_BEH_SUS < 5 THEN CAST(prepost.POST_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.POST_BEH_SUS >= 5 AND prepost.POST_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.POST_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS POST_BEH_SUS_CAT,
CASE WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF > 0 THEN 'Increased' WHEN prepost.PRE_BEH_OFF = 0 and prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromZero,
CASE WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET > 0 THEN 'Increased' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromZero,
CASE WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS > 0 THEN 'Increased' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromZero,
CASE WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF > prepost.POST_BEH_OFF THEN 'Decreased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF = prepost.POST_BEH_OFF THEN 'No change' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF < prepost.POST_BEH_OFF THEN 'Increased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromGTZero,
CASE WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET > prepost.POST_BEH_DET THEN 'Decreased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET = prepost.POST_BEH_DET THEN 'No change' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET < prepost.POST_BEH_DET THEN 'Increased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromGTZero,
CASE WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS > prepost.POST_BEH_SUS THEN 'Decreased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS = prepost.POST_BEH_SUS THEN 'No change' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS < prepost.POST_BEH_SUS THEN 'Increased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromGTZero
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN ReportCYData.dbo.EVAL_BEH AS prepost
ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 2)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015';

-- QUERY SYNTAX (Merge to pre/post BEH data -- BASED ON ABOVE QUERY -- STEP 2 -- this extra step is required since calculations/joins on new variables can't reference variables that were just created in the same query):

DROP TABLE ImpactAnalytics.dbo.FY15_SOY_BEH_SCHOOL_BASED
SELECT BEH.*
INTO ImpactAnalytics.dbo.FY15_SOY_BEH_SCHOOL_BASED
FROM
(*****ABOVE_QUERY*****)
AS BEH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;

-- QUERY SYNTAX (Merge and concatenate - SINGLE QUERY VERSION)

DROP TABLE ImpactAnalytics.dbo.FY15_SOY_BEH_SCHOOL_BASED
SELECT BEH.*
INTO ImpactAnalytics.dbo.FY15_SOY_BEH_SCHOOL_BASED
FROM
(SELECT ReportCYData.dbo.RPT_STUDENT_MAIN.SITE_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID, ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.PRE_BEH_VALUE, prepost.PRE_BEH_SUS, prepost.PRE_BEH_SUS_DESC, prepost.PRE_BEH_DET, prepost.PRE_BEH_DET_DESC, prepost.PRE_BEH_OFF, prepost.PRE_BEH_OFF_DESC, prepost.PRE_SCENARIO, prepost.POST_BEH_VALUE, prepost.POST_BEH_SUS, prepost.POST_BEH_SUS_DESC, prepost.POST_BEH_DET, prepost.POST_BEH_DET_DESC, prepost.POST_BEH_OFF, prepost.POST_BEH_OFF_DESC, prepost.POST_SCENARIO, prepost.ENROLLED_DAYS, prepost.ENROLLED_DAYS_CATEGORIES, prepost.TTL_TIME, prepost.DOSAGE_CATEGORIES, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, ReportCYData.dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.ENROLLED_DAYS >= 56 THEN 1 WHEN prepost.ENROLLED_DAYS < 56 THEN 0 ELSE NULL END AS EOY_MET_56_DAYS,
CASE WHEN prepost.PRE_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.PRE_BEH_OFF < 5 THEN CAST(prepost.PRE_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.PRE_BEH_OFF >= 5 AND prepost.PRE_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.PRE_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS PRE_BEH_OFF_CAT,
CASE WHEN prepost.PRE_BEH_DET = 1 THEN '1 detention' WHEN prepost.PRE_BEH_DET < 5 THEN CAST(prepost.PRE_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.PRE_BEH_DET >= 5 AND prepost.PRE_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.PRE_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS PRE_BEH_DET_CAT,
CASE WHEN prepost.PRE_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.PRE_BEH_SUS < 5 THEN CAST(prepost.PRE_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.PRE_BEH_SUS >= 5 AND prepost.PRE_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.PRE_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS PRE_BEH_SUS_CAT,
CASE WHEN prepost.POST_BEH_OFF = 1 THEN '1 office referral' WHEN prepost.POST_BEH_OFF < 5 THEN CAST(prepost.POST_BEH_OFF AS VARCHAR) + ' office referrals' WHEN prepost.POST_BEH_OFF >= 5 AND prepost.POST_BEH_OFF < 11 THEN '5-10 office referrals' WHEN prepost.POST_BEH_OFF >= 11 THEN '11+ office referrals' ELSE NULL END AS POST_BEH_OFF_CAT,
CASE WHEN prepost.POST_BEH_DET = 1 THEN '1 detention' WHEN prepost.POST_BEH_DET < 5 THEN CAST(prepost.POST_BEH_DET AS VARCHAR) + ' detentions' WHEN prepost.POST_BEH_DET >= 5 AND prepost.POST_BEH_DET < 11 THEN '5-10 detentions' WHEN prepost.POST_BEH_DET >= 11 THEN '11+ detentions' ELSE NULL END AS POST_BEH_DET_CAT,
CASE WHEN prepost.POST_BEH_SUS = 1 THEN '1 suspension' WHEN prepost.POST_BEH_SUS < 5 THEN CAST(prepost.POST_BEH_SUS AS VARCHAR) + ' suspensions' WHEN prepost.POST_BEH_SUS >= 5 AND prepost.POST_BEH_SUS < 11 THEN '5-10 suspensions' WHEN prepost.POST_BEH_SUS >= 11 THEN '11+ suspensions' ELSE NULL END AS POST_BEH_SUS_CAT,
CASE WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_OFF = 0 AND prepost.POST_BEH_OFF > 0 THEN 'Increased' WHEN prepost.PRE_BEH_OFF = 0 and prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromZero,
CASE WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET > 0 THEN 'Increased' WHEN prepost.PRE_BEH_DET = 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromZero,
CASE WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS = 0 THEN 'Maintained (Prevention)' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS > 0 THEN 'Increased' WHEN prepost.PRE_BEH_SUS = 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromZero,
CASE WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF > prepost.POST_BEH_OFF THEN 'Decreased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF = prepost.POST_BEH_OFF THEN 'No change' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.PRE_BEH_OFF < prepost.POST_BEH_OFF THEN 'Increased' WHEN prepost.PRE_BEH_OFF > 0 AND prepost.POST_BEH_OFF IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_OFF_FromGTZero,
CASE WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET > prepost.POST_BEH_DET THEN 'Decreased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET = prepost.POST_BEH_DET THEN 'No change' WHEN prepost.PRE_BEH_DET > 0 AND prepost.PRE_BEH_DET < prepost.POST_BEH_DET THEN 'Increased' WHEN prepost.PRE_BEH_DET > 0 AND prepost.POST_BEH_DET IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_DET_FromGTZero,
CASE WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS > prepost.POST_BEH_SUS THEN 'Decreased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS = prepost.POST_BEH_SUS THEN 'No change' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.PRE_BEH_SUS < prepost.POST_BEH_SUS THEN 'Increased' WHEN prepost.PRE_BEH_SUS > 0 AND prepost.POST_BEH_SUS IS NULL THEN 'Insufficient data' ELSE NULL END AS EOY_SUS_FromGTZero
FROM ReportCYData.dbo.RPT_SCHOOL_GRADE INNER JOIN (ReportCYData.dbo.RPT_STUDENT_MAIN INNER JOIN ReportCYData.dbo.EVAL_BEH AS prepost
ON (ReportCYData.dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (ReportCYData.dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.SCHOOL_ID AND ReportCYData.dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 2)
WHERE ReportCYData.dbo.RPT_SCHOOL_GRADE.GRADE_ID = ReportCYData.dbo.RPT_STUDENT_MAIN.GRADE_ID AND prepost.FISCAL_YEAR LIKE '2014-2015' AND ReportCYData.dbo.RPT_SCHOOL_GRADE.FISCAL_YEAR LIKE '2014-2015')
AS BEH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;